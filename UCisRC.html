<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory UCisRC</title>
</head>


<body>
<div class="head">
<h1>Theory UCisRC</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">theory</span></span> UCisRC
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="../../HOL/HOL/Real.html">HOL.Real</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Requirements for UC-style compositionality"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'color</span><span class="main">)</span> prgm <span class="main">=</span> Prgrm <span class="tfree"><span class="quoted"><span class="tfree">'color</span></span></span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'color</span><span class="main">)</span> ctxt <span class="main">=</span> Ctxt <span class="tfree"><span class="quoted"><span class="tfree">'color</span></span></span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'color</span><span class="main">)</span> whle <span class="main">=</span> Whle <span class="tfree"><span class="quoted"><span class="tfree">'color</span></span></span>

<span class="keyword1"><span class="command">consts</span></span> 
  call<span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'blue</span> prgm <span class="main">⇒</span> <span class="tfree">'red</span> prgm <span class="main">⇒</span> <span class="tfree">'blue</span> prgm"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">∘∘</span>"</span>  60<span class="main">)</span>
  bigcall<span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'blue</span> whle <span class="main">⇒</span> <span class="tfree">'red</span> whle <span class="main">⇒</span> <span class="tfree">'blue</span> whle"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">∘∘∘</span>"</span> 52<span class="main">)</span>
  par<span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'blue</span> ctxt <span class="main">⇒</span> <span class="tfree">'red</span> ctxt <span class="main">⇒</span> <span class="tfree">'blue</span> ctxt"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∥</span>"</span> 60<span class="main">)</span>
  link<span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> ctxt <span class="main">⇒</span> <span class="tfree">'b</span> prgm <span class="main">⇒</span> <span class="tfree">'b</span> whle"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">&gt;&lt;</span>"</span> 55<span class="main">)</span> 
  ple <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> whle <span class="main">⇒</span> <span class="tfree">'d</span> whle <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">≲</span>"</span> 50<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">RRgen</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span> whle <span class="main">⇒</span> <span class="tfree">'b</span> whle <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'r</span> prgm <span class="main">⇒</span> <span class="tfree">'b</span> prgm <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">RRgen</span> <span class="free"><span class="bound"><span class="entity">rel</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">::</span><span class="tfree">'r</span> prgm<span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">::</span><span class="tfree">'b</span> prgm<span class="main">)</span> <span class="main">≡</span> 
    <span class="main">∀</span> <span class="main">(</span><span class="bound">A</span><span class="main">::</span><span class="tfree">'r</span> ctxt<span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="main">(</span><span class="bound">S</span><span class="main">::</span><span class="tfree">'b</span> ctxt<span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">rel</span></span></span> <span class="main">(</span><span class="bound">A</span> <span class="main">&gt;&lt;</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span><span class="bound">S</span> <span class="main">&gt;&lt;</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">RR</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'r</span> prgm <span class="main">⇒</span> <span class="tfree">'b</span> prgm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">robustly-refines</span> _"</span> <span class="main">[</span>20<span class="main">,</span>20<span class="main">]</span> 17<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">RR</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> RRgen ple <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>


<span class="keyword1"><span class="command">locale</span></span> composition <span class="main">=</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> par_decomp<span class="main">:</span> <span class="comment1">(* parallel decomposition (for pink programs using red programs) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">A</span><span class="main">::</span><span class="tfree">'p</span> ctxt<span class="main">)</span> <span class="main">(</span><span class="bound">P1</span><span class="main">::</span><span class="tfree">'p</span> prgm<span class="main">)</span> <span class="main">(</span><span class="bound">P2</span><span class="main">::</span><span class="tfree">'r</span> prgm<span class="main">)</span> <span class="main">.</span>
             <span class="main">∃</span> <span class="main">(</span><span class="bound">A1</span><span class="main">::</span><span class="tfree">'p</span> ctxt<span class="main">)</span> <span class="main">(</span><span class="bound">A2</span><span class="main">::</span><span class="tfree">'r</span> ctxt<span class="main">)</span><span class="main">.</span>
      <span class="bound">A</span> <span class="main">&gt;&lt;</span> <span class="bound">P1</span> <span class="main">∘∘</span> <span class="bound">P2</span> <span class="main">≲</span> <span class="bound">A1</span> <span class="main">∥</span> <span class="bound">A2</span> <span class="main">&gt;&lt;</span> <span class="bound">P1</span> <span class="main">∘∘</span> <span class="bound">P2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inter_comp<span class="main">:</span> <span class="comment1">(* intertwined composition (dito) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">P1</span><span class="main">::</span><span class="tfree">'p</span> prgm<span class="main">)</span> <span class="main">(</span><span class="bound">P2</span><span class="main">::</span><span class="tfree">'r</span> prgm<span class="main">)</span> 
              <span class="main">(</span><span class="bound">A1</span><span class="main">::</span><span class="tfree">'p</span> ctxt<span class="main">)</span> <span class="main">(</span><span class="bound">A2</span><span class="main">::</span><span class="tfree">'r</span> ctxt<span class="main">)</span><span class="main">.</span>
       <span class="bound">A1</span> <span class="main">∥</span> <span class="bound">A2</span> <span class="main">&gt;&lt;</span> <span class="bound">P1</span> <span class="main">∘∘</span> <span class="bound">P2</span> <span class="main">≲</span> <span class="bound">A1</span> <span class="main">&gt;&lt;</span> <span class="bound">P1</span> <span class="main">∘∘∘</span> <span class="bound">A2</span> <span class="main">&gt;&lt;</span> <span class="bound">P2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inter_decomp<span class="main">:</span> <span class="comment1">(* intertwined composition (for pink programs using blue programs) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">P1</span><span class="main">::</span><span class="tfree">'p</span> prgm<span class="main">)</span> <span class="main">(</span><span class="bound">P2</span><span class="main">::</span><span class="tfree">'b</span> prgm<span class="main">)</span> <span class="bound">A1</span> <span class="bound">A2</span> <span class="main">.</span>
    <span class="bound">A1</span> <span class="main">&gt;&lt;</span> <span class="bound">P1</span> <span class="main">∘∘∘</span> <span class="bound">A2</span> <span class="main">&gt;&lt;</span> <span class="bound">P2</span>  <span class="main">≲</span>   <span class="bound">A1</span> <span class="main">∥</span> <span class="bound">A2</span> <span class="main">&gt;&lt;</span> <span class="bound">P1</span> <span class="main">∘∘</span> <span class="bound">P2</span> "</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>  const_elim<span class="main">:</span> <span class="comment1">(* constant elimination (for plugging substituting red with blue in pink contexts*)</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">redW</span><span class="main">::</span><span class="tfree">'r</span> whle<span class="main">)</span> <span class="main">(</span><span class="bound">blueW</span><span class="main">::</span><span class="tfree">'b</span> whle<span class="main">)</span> <span class="main">(</span><span class="bound">pinkW</span><span class="main">::</span><span class="tfree">'p</span> whle<span class="main">)</span> <span class="main">.</span>
       <span class="main">(</span> <span class="main">(</span><span class="bound">redW</span> <span class="main">≲</span> <span class="bound">blueW</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span> <span class="bound">pinkW</span> <span class="main">∘∘∘</span> <span class="bound">redW</span> <span class="main">≲</span> <span class="bound">pinkW</span> <span class="main">∘∘∘</span> <span class="bound">blueW</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> transitivity <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="comment1">(* transitivity of trace relation for pink programs *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">W1</span><span class="main">::</span><span class="tfree">'p</span> whle<span class="main">)</span> <span class="main">≲</span> <span class="main">(</span><span class="free">W2</span><span class="main">::</span><span class="tfree">'p</span> whle<span class="main">)</span>
    <span class="main">⟹</span>  <span class="free">W2</span> <span class="main">≲</span> <span class="main">(</span><span class="free">W3</span><span class="main">::</span><span class="tfree">'p</span> whle<span class="main">)</span>  <span class="main">⟹</span> <span class="free">W1</span> <span class="main">≲</span> <span class="free">W3</span>"</span></span>

 <span class="comment1">(* new axioms for dummy adversary theorem *)</span>
<span class="keyword1"><span class="command">locale</span></span> dummy <span class="main">=</span>
  <span class="comment1">(* dummy context and program *)</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Pd</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'r</span> prgm"</span></span> <span class="comment1">(* Z→Pd ⇒ Z→Psub, A→Pd⇒ ?  , Psub→Pd⇒ Psub⇒Z, *)</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Ad</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'r</span> ctxt"</span></span> <span class="comment1">(* Z→Ad ⇒ Z→P,    P→ Ad ⇒ P→Z *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> adv_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">" <span class="main">∀</span> <span class="bound">A</span> <span class="bound">P</span> <span class="main">.</span> <span class="main">∃</span> <span class="bound">A'</span> <span class="main">.</span> <span class="bound">A</span> <span class="main">&gt;&lt;</span> <span class="bound">P</span> <span class="main">≲</span> <span class="main">(</span><span class="bound">A'</span> <span class="main">&gt;&lt;</span> <span class="free">Pd</span><span class="main">)</span> <span class="main">∘∘∘</span> <span class="main">(</span><span class="free">Ad</span> <span class="main">&gt;&lt;</span> <span class="bound">P</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> adv_unsplit<span class="main">:</span>
  <span class="quoted"><span class="quoted">" <span class="main">∀</span> <span class="bound">A1</span> <span class="main">(</span><span class="bound">A2</span><span class="main">::</span><span class="tfree">'b</span> ctxt<span class="main">)</span> <span class="main">(</span><span class="bound">P</span><span class="main">::</span><span class="tfree">'b</span> prgm<span class="main">)</span> <span class="main">.</span> <span class="main">∃</span> <span class="bound">A</span> <span class="main">.</span> <span class="main">(</span><span class="bound">A1</span> <span class="main">∥</span> <span class="bound">A2</span><span class="main">)</span> <span class="main">&gt;&lt;</span> <span class="main">(</span><span class="free">Pd</span> <span class="main">∘∘</span> <span class="bound">P</span><span class="main">)</span> <span class="main">≲</span> <span class="bound">A</span> <span class="main">&gt;&lt;</span> <span class="bound">P</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span>  const_elim2<span class="main">:</span> <span class="comment1">(* constant elimination for red contexts *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">redW</span><span class="main">::</span><span class="tfree">'r</span> whle<span class="main">)</span> <span class="main">(</span><span class="bound">blueW</span><span class="main">::</span><span class="tfree">'b</span> whle<span class="main">)</span> <span class="main">(</span><span class="bound">W</span><span class="main">::</span><span class="tfree">'r</span> whle<span class="main">)</span> <span class="main">.</span>
       <span class="main">(</span> <span class="main">(</span><span class="bound">redW</span> <span class="main">≲</span> <span class="bound">blueW</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span> <span class="bound">W</span> <span class="main">∘∘∘</span> <span class="bound">redW</span> <span class="main">≲</span> <span class="bound">W</span> <span class="main">∘∘∘</span> <span class="bound">blueW</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inter_decomp2<span class="main">:</span> <span class="comment1">(* intertwined composition (for pink programs using blue programs) *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">P1</span><span class="main">::</span><span class="tfree">'r</span> prgm<span class="main">)</span> <span class="main">(</span><span class="bound">P2</span><span class="main">::</span><span class="tfree">'b</span> prgm<span class="main">)</span> <span class="bound">A1</span> <span class="bound">A2</span><span class="main">.</span>
    <span class="bound">A1</span> <span class="main">&gt;&lt;</span> <span class="bound">P1</span> <span class="main">∘∘∘</span> <span class="bound">A2</span> <span class="main">&gt;&lt;</span> <span class="bound">P2</span>  <span class="main">≲</span>  <span class="bound">A1</span> <span class="main">∥</span> <span class="bound">A2</span> <span class="main">&gt;&lt;</span> <span class="bound">P1</span> <span class="main">∘∘</span> <span class="bound">P2</span> "</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> transitivity2 <span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="comment1">(* transitivity of trace relation for red programs *)</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">W1</span><span class="main">::</span><span class="tfree">'r</span> whle<span class="main">)</span> <span class="main">≲</span> <span class="main">(</span><span class="free">W2</span><span class="main">::</span><span class="tfree">'r</span> whle<span class="main">)</span>
    <span class="main">⟹</span>  <span class="free">W2</span> <span class="main">≲</span> <span class="main">(</span><span class="free">W3</span><span class="main">::</span><span class="tfree">'r</span> whle<span class="main">)</span>  <span class="main">⟹</span> <span class="free">W1</span> <span class="main">≲</span> <span class="free">W3</span>"</span></span>


<span class="keyword1"><span class="command">context</span></span> dummy
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*
declare [[show_types]]

theorem dummy:
  fixes P::"'r prgm"
  fixes F::"'b prgm"
  assumes A: " ∃ (S::'b ctxt) . Ad &gt;&lt; P ≲ S &gt;&lt; F"
  assumes transitivity3 : (* transitivity of trace relation for red programs *)
  "(W1::'r whle) ≲ (W2::'r whle)
    ⟹  W2 ≲ (W3::'b whle)  ⟹ W1 ≲ W3"
shows "∀ (A::'r ctxt). ∃ (S::'b ctxt) . A &gt;&lt; P ≲ S &gt;&lt; F"
proof
  fix A 
  from adv_split obtain A' where "A &gt;&lt; P ≲ (A' &gt;&lt; Pd) ∘∘∘ (Ad &gt;&lt; P)" by auto
  also obtain S where "... ≲ (A' &gt;&lt; Pd) ∘∘∘ (S &gt;&lt; F)" using A const_elim2 by blast
  also have "... ≲ ((A' ∥ S) &gt;&lt; (Pd ∘∘ F))" using inter_decomp2 by blast
  finally have Almost:"A &gt;&lt; P ≲ ((A' ∥ S) &gt;&lt; (Pd ∘∘ F))".
  then have Trans:"∀ W3. ((A' ∥ S) &gt;&lt; (Pd ∘∘ F)) ≲ W3 ⟶  A &gt;&lt; P ≲ W3" using transitivity3 by blast
  (* somethings odd about transitivity ... Trans is a crutch because we could not have 
  transitivity3 in the "also have" chain *)

  obtain S' where "((A' ∥ S) &gt;&lt; (Pd ∘∘ F)) ≲ S' &gt;&lt; F" using adv_unsplit by blast
  from this Trans have "A &gt;&lt; P ≲ S' &gt;&lt; F" by fastforce
  thus "∃ (S::'b ctxt) . A &gt;&lt; P ≲ S &gt;&lt; F" by auto
 qed
*)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> composition
<span class="keyword2"><span class="keyword">begin</span></span>

<span id="composition"><span class="keyword1"><span class="command">theorem</span></span> composition<span class="main">:</span>
</span>  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'r</span> prgm"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> prgm"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'p</span> prgm"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">robustly-refines</span> <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">∘∘</span> <span class="free">P</span> <span class="keyword1">robustly-refines</span> <span class="free">R</span> <span class="main">∘∘</span> <span class="free">F</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span>
  <span class="keyword1"><span class="command">from</span></span> par_decomp <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A1</span></span> <span class="skolem"><span class="skolem">A2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span> <span class="main">&gt;&lt;</span> <span class="free">R</span> <span class="main">∘∘</span> <span class="free">P</span><span class="main">)</span> <span class="main">≲</span> <span class="main">(</span><span class="main">(</span><span class="skolem">A1</span><span class="main">::</span><span class="tfree">'p</span> ctxt<span class="main">)</span> <span class="main">∥</span> <span class="main">(</span><span class="skolem">A2</span><span class="main">::</span> <span class="tfree">'r</span> ctxt<span class="main">)</span> <span class="main">&gt;&lt;</span> <span class="free">R</span> <span class="main">∘∘</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≲</span>  <span class="main">(</span><span class="skolem">A1</span> <span class="main">&gt;&lt;</span> <span class="free">R</span> <span class="main">∘∘∘</span> <span class="skolem">A2</span> <span class="main">&gt;&lt;</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>inter_comp<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> OK<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span> <span class="main">&gt;&lt;</span> <span class="free">R</span> <span class="main">∘∘</span> <span class="free">P</span><span class="main">)</span> <span class="main">≲</span>  <span class="main">(</span><span class="skolem">A1</span> <span class="main">&gt;&lt;</span> <span class="free">R</span> <span class="main">∘∘∘</span> <span class="skolem">A2</span> <span class="main">&gt;&lt;</span> <span class="free">P</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  
  <span class="keyword1"><span class="command">from</span></span> A <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A2</span> <span class="main">&gt;&lt;</span> <span class="free">P</span><span class="main">)</span> <span class="main">≲</span> <span class="main">(</span><span class="skolem">S2</span> <span class="main">&gt;&lt;</span> <span class="free">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A1</span> <span class="main">&gt;&lt;</span> <span class="free">R</span><span class="main">)</span> <span class="main">∘∘∘</span> <span class="main">(</span><span class="skolem">A2</span> <span class="main">&gt;&lt;</span> <span class="free">P</span><span class="main">)</span> <span class="main">≲</span> <span class="main">(</span><span class="skolem">A1</span> <span class="main">&gt;&lt;</span> <span class="free">R</span><span class="main">)</span> <span class="main">∘∘∘</span> <span class="main">(</span><span class="skolem">S2</span> <span class="main">&gt;&lt;</span> <span class="free">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>const_elim<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≲</span> <span class="main">(</span><span class="skolem">A1</span> <span class="main">∥</span> <span class="skolem">S2</span><span class="main">)</span> <span class="main">&gt;&lt;</span> <span class="main">(</span><span class="free">R</span> <span class="main">∘∘</span> <span class="free">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>inter_decomp<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A1</span> <span class="main">&gt;&lt;</span> <span class="free">R</span><span class="main">)</span> <span class="main">∘∘∘</span> <span class="main">(</span><span class="skolem">A2</span> <span class="main">&gt;&lt;</span> <span class="free">P</span><span class="main">)</span> <span class="main">≲</span> <span class="main">(</span><span class="skolem">A1</span> <span class="main">∥</span> <span class="skolem">S2</span><span class="main">)</span> <span class="main">&gt;&lt;</span> <span class="main">(</span><span class="free">R</span> <span class="main">∘∘</span> <span class="free">F</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> this OK <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span> <span class="main">&gt;&lt;</span> <span class="free">R</span> <span class="main">∘∘</span> <span class="free">P</span><span class="main">)</span> <span class="main">≲</span> <span class="main">(</span><span class="skolem">A1</span> <span class="main">∥</span> <span class="skolem">S2</span><span class="main">)</span> <span class="main">&gt;&lt;</span> <span class="main">(</span><span class="free">R</span> <span class="main">∘∘</span> <span class="free">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> transitivity<span class="main">)</span>   
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">S</span> <span class="main">.</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">&gt;&lt;</span> <span class="free">R</span> <span class="main">∘∘</span> <span class="free">P</span><span class="main">)</span> <span class="main">≲</span> <span class="bound">S</span> <span class="main">&gt;&lt;</span> <span class="main">(</span><span class="free">R</span> <span class="main">∘∘</span> <span class="free">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Relating UC to RSCH"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'r</span><span class="main">)</span> comp <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> prgm <span class="main">⇒</span> <span class="tfree">'r</span> prgm"</span></span>

<span class="keyword1"><span class="command">consts</span></span>
       leadsto <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> whle <span class="main">⇒</span> <span class="tfree">'t</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">↝</span>"</span> 51<span class="main">)</span>
       prefix <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> <span class="main">⇒</span> bool"</span></span>

<span class="comment1">(* We instantiate RSCHP from RRgen above, meaning we can instantiate ple above with RSCHPrel below 
   if we want to have the composition result from the particular relation we need here. *)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">RSCHPrel</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">RSCHPrel</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">::</span> <span class="tfree">'t</span> itself<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">W</span></span></span> <span class="free"><span class="bound"><span class="entity">W'</span></span></span> <span class="main">≡</span> 
        <span class="main">(</span><span class="main">∀</span> <span class="bound">m</span> <span class="main">::</span> <span class="tfree">'t</span> <span class="main">.</span> prefix <span class="bound">m</span> <span class="main">⟶</span>  <span class="free"><span class="bound"><span class="entity">W</span></span></span> <span class="main">↝</span> <span class="bound">m</span> <span class="main">⟶</span>  <span class="free"><span class="bound"><span class="entity">W'</span></span></span> <span class="main">↝</span> <span class="bound">m</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">RSCHP</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">RSCHP</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">::</span> <span class="tfree">'t</span> itself<span class="main">)</span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">P</span> <span class="main">.</span> RRgen <span class="main">(</span>RSCHPrel <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">::</span> <span class="tfree">'t</span> itself<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="bound">P</span><span class="main">)</span> <span class="bound">P</span>"</span></span>


<span class="keyword1"><span class="command">locale</span></span> UC <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">PrExec</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'env</span> <span class="main">⇒</span> <span class="tfree">'uc</span> ctxt <span class="main">⇒</span> <span class="tfree">'uc</span> prgm <span class="main">⇒</span> bool <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">PrExecT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'env</span> <span class="main">⇒</span> <span class="tfree">'uc</span> ctxt <span class="main">⇒</span> <span class="tfree">'uc</span> prgm <span class="main">⇒</span> <span class="tfree">'t</span> <span class="main">⇒</span> real"</span></span>
    <span class="comment1">(* Note: PrExec and PrExecT are total function. Hence, when the random vars Exec or ExecT are
       undefined, we give them probability zero.  *)</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">β</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> <span class="main">⇒</span> bool"</span></span> <span class="comment1">(* extracts final bit from trace *)</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Zcan</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> <span class="main">⇒</span> <span class="tfree">'env</span>"</span></span> <span class="comment1">(* canonical Z: produces messages to A and P as specified by t *)</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">nonprobabilistic</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'env</span> <span class="main">⇒</span> bool"</span></span>
  
  <span class="comment1">(* assumptions needed in both directions *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> relation_uc<span class="main">:</span> <span class="comment1">(* We can define a semantic's from UC's semantics. *)</span>
    <span class="quoted"><span class="quoted">"prefix <span class="free">t</span> <span class="main">⟶</span>  <span class="main">(</span><span class="free">A</span> <span class="main">&gt;&lt;</span> <span class="free">P</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">p</span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="free">PrExecT</span> <span class="main">(</span><span class="free">Zcan</span> <span class="free">t</span><span class="main">)</span> <span class="free">A</span> <span class="free">P</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> prefix_iff_trace_is_prefix<span class="main">:</span> <span class="comment1">(* PL-level trace (i.e., tuple) is prefix is the UC trace in it is. *)</span>
    <span class="quoted"><span class="quoted">"prefix <span class="main">(</span><span class="free">t</span><span class="main">::</span><span class="tfree">'t</span><span class="main">,</span><span class="free">p</span><span class="main">::</span>real<span class="main">)</span> <span class="main">≡</span> prefix <span class="free">t</span>"</span></span>

  <span class="comment1">(* only needed in RSCHPtoUC *)</span>
  <span class="keyword2"><span class="keyword">and</span></span> prefixes_contain_final_bit<span class="main">:</span> <span class="comment1">(* every finite trace contains the final bit *)</span>
    <span class="quoted"><span class="quoted">"<span class="free">PrExec</span> <span class="free">Z</span> <span class="free">A</span> <span class="free">P</span> <span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">t</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> prefix <span class="bound">t</span> <span class="main">∧</span> <span class="free">β</span> <span class="bound">t</span> <span class="main">=</span> <span class="free">b</span><span class="main">}</span>  <span class="main">.</span> <span class="free">PrExecT</span> <span class="free">Z</span> <span class="free">A</span> <span class="free">P</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nonprobabilistic_envs_are_complete<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">Z</span> <span class="bound">b</span><span class="main">.</span> <span class="free">PrExec</span> <span class="bound">Z</span> <span class="free">A</span> <span class="free">P</span> <span class="bound">b</span> <span class="main">≠</span> <span class="free">PrExec</span> <span class="bound">Z</span> <span class="free">S</span> <span class="free">F</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">Z'</span> <span class="main">.</span> <span class="free">PrExec</span> <span class="bound">Z'</span> <span class="free">A</span> <span class="free">P</span> True <span class="main">≠</span> <span class="free">PrExec</span> <span class="bound">Z'</span> <span class="free">S</span> <span class="free">F</span> True <span class="main">∧</span> <span class="free">nonprobabilistic</span> <span class="bound">Z'</span><span class="main">)</span>"</span></span>  
  <span class="keyword2"><span class="keyword">and</span></span> construct_canonical_env<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">nonprobabilistic</span> <span class="free">Z</span><span class="main">;</span>  prefix <span class="free">t</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">PrExecT</span> <span class="free">Z</span> <span class="free">A</span> <span class="free">P</span> <span class="free">t</span> <span class="main">=</span> <span class="free">PrExecT</span> <span class="main">(</span><span class="free">Zcan</span> <span class="free">t</span><span class="main">)</span> <span class="free">A</span> <span class="free">P</span> <span class="free">t</span>"</span></span>

  <span class="comment1">(* only needed in UCtoRSCHP *)</span>
  <span class="keyword2"><span class="keyword">and</span></span> construct_canonical_env2<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span>prefix <span class="free">t</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">PrExecT</span> <span class="main">(</span><span class="free">Zcan</span> <span class="free">t</span><span class="main">)</span> <span class="free">A</span> <span class="free">P</span> <span class="free">t</span> <span class="main">=</span> <span class="free">PrExec</span> <span class="main">(</span><span class="free">Zcan</span> <span class="free">t</span><span class="main">)</span> <span class="free">A</span> <span class="free">P</span> True"</span></span>

  <span class="comment1">(* axioms of probabilities *)</span>
  <span class="keyword2"><span class="keyword">and</span></span> unit_interval<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">PrExec</span> <span class="free">Z</span> <span class="free">A</span> <span class="free">P</span> True <span class="main">=</span> <span class="main">1</span><span class="main">-</span> <span class="free">PrExec</span> <span class="free">Z</span> <span class="free">A</span> <span class="free">P</span> False"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> unit_interval_min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">PrExec</span> <span class="free">Z</span> <span class="free">A</span> <span class="free">P</span> <span class="free">b</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> PrExecT_unit_interval_min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">PrExecT</span> <span class="free">Z</span> <span class="free">A</span> <span class="free">P</span> <span class="free">t</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> UC
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">UCemulates</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'uc</span> prgm <span class="main">⇒</span> <span class="tfree">'uc</span> prgm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">UC-emulates</span>"</span> 45<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">UCemulates</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">A</span> <span class="main">.</span> <span class="main">∃</span> <span class="main">(</span><span class="bound">S</span><span class="main">::</span><span class="tfree">'uc</span> ctxt<span class="main">)</span> <span class="main">.</span> <span class="main">∀</span> <span class="main">(</span><span class="bound">Z</span><span class="main">::</span><span class="tfree">'env</span><span class="main">)</span><span class="main">.</span> 
    <span class="main">(</span><span class="free">PrExec</span> <span class="bound">Z</span> <span class="bound">A</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> True <span class="main">=</span> <span class="free">PrExec</span> <span class="bound">Z</span> <span class="bound">S</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> True<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> difference_in_sum' <span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span><span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">∑</span> <span class="bound">x</span><span class="main">∈</span> <span class="free">P</span> <span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span><span class="main">∈</span><span class="free">P</span> <span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="free">g</span> <span class="bound">x</span> "</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> CF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span> <span class="bound">x</span><span class="main">∈</span><span class="free">P</span> <span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> CF <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">∈</span> <span class="free">P</span><span class="main">.</span>  <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span>  <span class="free">g</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span>  <span class="main">(</span><span class="bound">x</span><span class="main">∈</span><span class="free">P</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> this sum_mono <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> distinguishingZ_differentTrace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">PrExecT</span> <span class="free">Z</span> <span class="free">A</span> <span class="free">P</span> <span class="free">t</span> <span class="main">≠</span> <span class="free">PrExecT</span> <span class="free">Z</span> <span class="free">S</span> <span class="free">F</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>  B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">PrExecT</span> <span class="free">Z</span> <span class="free">A</span> <span class="free">P</span> <span class="free">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Z <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nonprobabilistic</span> <span class="free">Z</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> T <span class="main">:</span> <span class="quoted"><span class="quoted">"prefix <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">p</span> <span class="main">::</span>real <span class="main">.</span><span class="main">(</span><span class="free">A</span> <span class="main">&gt;&lt;</span> <span class="free">P</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span><span class="main">(</span><span class="free">S</span> <span class="main">&gt;&lt;</span> <span class="free">F</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> Z construct_canonical_env A T <span class="keyword1"><span class="command">have</span></span> A'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">PrExecT</span> <span class="main">(</span><span class="free">Zcan</span> <span class="free">t</span><span class="main">)</span> <span class="free">A</span> <span class="free">P</span> <span class="free">t</span> <span class="main">≠</span> <span class="free">PrExecT</span> <span class="main">(</span><span class="free">Zcan</span> <span class="free">t</span><span class="main">)</span> <span class="free">S</span> <span class="free">F</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> Z construct_canonical_env B T <span class="keyword1"><span class="command">have</span></span> B'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">PrExecT</span> <span class="main">(</span><span class="free">Zcan</span> <span class="free">t</span><span class="main">)</span> <span class="free">A</span> <span class="free">P</span> <span class="free">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">PrExecT</span> <span class="main">(</span><span class="free">Zcan</span> <span class="free">t</span><span class="main">)</span> <span class="free">A</span> <span class="free">P</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> relation_uc B' <span class="keyword1"><span class="command">have</span></span> Yes<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">&gt;&lt;</span> <span class="free">P</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="var">?p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> No<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">(</span><span class="free">S</span> <span class="main">&gt;&lt;</span> <span class="free">F</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="var">?p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">¬</span><span class="main">(</span><span class="free">S</span> <span class="main">&gt;&lt;</span> <span class="free">F</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="var">?p</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> C relation_uc T <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">PrExecT</span> <span class="main">(</span><span class="free">Zcan</span> <span class="free">t</span><span class="main">)</span> <span class="free">S</span> <span class="free">F</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="var">?p</span> <span class="main">∧</span> <span class="var">?p</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">PrExecT</span> <span class="main">(</span><span class="free">Zcan</span> <span class="free">t</span><span class="main">)</span> <span class="free">S</span> <span class="free">F</span> <span class="free">t</span> <span class="main">=</span> <span class="var">?p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> this A' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> Yes No <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> greater_to_unequal_and_nonzero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Greater<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">PrExecT</span> <span class="free">Z</span> <span class="free">A</span> <span class="free">P</span> <span class="free">t</span> <span class="main">&gt;</span> <span class="free">PrExecT</span> <span class="free">Z</span> <span class="free">S</span> <span class="free">F</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">PrExecT</span> <span class="free">Z</span> <span class="free">A</span> <span class="free">P</span> <span class="free">t</span> <span class="main">≠</span> <span class="free">PrExecT</span> <span class="free">Z</span> <span class="free">S</span> <span class="free">F</span> <span class="free">t</span> <span class="main">∧</span> <span class="free">PrExecT</span> <span class="free">Z</span> <span class="free">A</span> <span class="free">P</span> <span class="free">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> PrExecT_unit_interval_min <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">PrExecT</span> <span class="free">Z</span> <span class="free">S</span> <span class="free">F</span> <span class="free">t</span> <span class="main">≥</span>  <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> this Greater <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">PrExecT</span> <span class="free">Z</span> <span class="free">A</span> <span class="free">P</span> <span class="free">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">from</span></span> this Greater <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> PrExec_bit_selects_inequality<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">PrExec</span> <span class="free">Z</span> <span class="free">A</span> <span class="free">P</span> True <span class="main">≠</span> <span class="free">PrExec</span> <span class="free">Z'</span> <span class="free">A'</span> <span class="free">P'</span> True"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">b</span><span class="main">.</span> <span class="free">PrExec</span> <span class="free">Z</span> <span class="free">A</span> <span class="free">P</span> <span class="bound">b</span> <span class="main">&gt;</span> <span class="free">PrExec</span> <span class="free">Z'</span> <span class="free">A'</span> <span class="free">P'</span> <span class="bound">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">consider</span></span> 
        <span class="main">(</span>A<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">PrExec</span> <span class="free">Z</span> <span class="free">A</span> <span class="free">P</span> True <span class="main">&gt;</span> <span class="free">PrExec</span> <span class="free">Z'</span> <span class="free">A'</span> <span class="free">P'</span> True"</span></span> 
      <span class="main">|</span> <span class="main">(</span>B<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">PrExec</span> <span class="free">Z</span> <span class="free">A</span> <span class="free">P</span> True <span class="main">&lt;</span> <span class="free">PrExec</span> <span class="free">Z'</span> <span class="free">A'</span> <span class="free">P'</span> True"</span></span>
     <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> A <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> B <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> unit_interval <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span id="RSCHPtoUC"><span class="keyword1"><span class="command">theorem</span></span> RSCHPtoUC<span class="main">:</span>
</span>  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">C</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'uc</span><span class="main">,</span><span class="tfree">'uc</span><span class="main">)</span> comp"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ttype</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'t</span> <span class="main">×</span> real<span class="main">)</span> itself"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"RSCHP <span class="free">C</span> <span class="free">ttype</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">P</span><span class="main">::</span><span class="tfree">'uc</span> prgm<span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="free">C</span> <span class="bound">P</span><span class="main">)</span> <span class="keyword1">UC-emulates</span> <span class="bound">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> CF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∀</span> <span class="bound">P</span> <span class="main">.</span> <span class="free">C</span> <span class="bound">P</span> <span class="keyword1">UC-emulates</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> CF <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span><span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'uc</span> prgm"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="free">C</span> <span class="skolem">P</span> <span class="keyword1">UC-emulates</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'uc</span> ctxt"</span></span> <span class="keyword2"><span class="keyword">where</span></span> CF1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">S</span><span class="main">::</span><span class="tfree">'uc</span> ctxt<span class="main">)</span> <span class="main">.</span> <span class="main">∃</span> <span class="main">(</span><span class="bound">Z</span><span class="main">::</span><span class="tfree">'env</span><span class="main">)</span><span class="main">.</span>
       <span class="free">PrExec</span> <span class="bound">Z</span> <span class="skolem">A</span> <span class="main">(</span><span class="free">C</span> <span class="skolem">P</span><span class="main">)</span> True <span class="main">≠</span> <span class="free">PrExec</span> <span class="bound">Z</span> <span class="bound">S</span> <span class="skolem">P</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> A <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'uc</span> ctxt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">m</span><span class="main">::</span> <span class="main">(</span><span class="tfree">'t</span> <span class="main">×</span> real<span class="main">)</span><span class="main">)</span><span class="main">.</span> prefix <span class="bound">m</span> <span class="main">⟶</span>  <span class="skolem">A</span> <span class="main">&gt;&lt;</span> <span class="free">C</span> <span class="skolem">P</span> <span class="main">↝</span> <span class="bound">m</span> <span class="main">⟶</span> <span class="skolem">S</span> <span class="main">&gt;&lt;</span> <span class="skolem">P</span> <span class="main">↝</span> <span class="bound">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">from</span></span> CF1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Z</span> <span class="main">.</span> <span class="free">PrExec</span> <span class="bound">Z</span> <span class="skolem">A</span> <span class="main">(</span><span class="free">C</span> <span class="skolem">P</span><span class="main">)</span> True <span class="main">≠</span> <span class="free">PrExec</span> <span class="bound">Z</span> <span class="skolem">S</span> <span class="skolem">P</span> True"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> 
       <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">Z</span> <span class="main">.</span> <span class="free">PrExec</span> <span class="bound">Z</span> <span class="skolem">A</span> <span class="main">(</span><span class="free">C</span> <span class="skolem">P</span><span class="main">)</span> True <span class="main">≠</span> <span class="free">PrExec</span> <span class="bound">Z</span> <span class="skolem">S</span> <span class="skolem">P</span> True <span class="main">∧</span> <span class="free">nonprobabilistic</span> <span class="bound">Z</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> nonprobabilistic_envs_are_complete <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Z</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'env</span>"</span></span> 
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">PrExec</span> <span class="skolem">Z</span> <span class="skolem">A</span> <span class="main">(</span><span class="free">C</span> <span class="skolem">P</span><span class="main">)</span> True <span class="main">≠</span> <span class="free">PrExec</span> <span class="skolem">Z</span> <span class="skolem">S</span> <span class="skolem">P</span> True"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> Prob<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nonprobabilistic</span> <span class="skolem">Z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="comment1">(* Need to select a bit here so that one is larger than the other – this was incorrect in the proof sketch. *)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">PrExec</span> <span class="skolem">Z</span> <span class="skolem">A</span> <span class="main">(</span><span class="free">C</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">b</span> <span class="main">&gt;</span> <span class="free">PrExec</span> <span class="skolem">Z</span> <span class="skolem">S</span> <span class="skolem">P</span> <span class="skolem">b</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> PrExec_bit_selects_inequality <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">t</span><span class="main">∈</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> prefix <span class="bound">t</span> <span class="main">∧</span> <span class="free">β</span> <span class="bound">t</span><span class="main">=</span> <span class="skolem">b</span><span class="main">}</span> <span class="main">.</span> <span class="free">PrExecT</span> <span class="skolem">Z</span> <span class="skolem">A</span> <span class="main">(</span><span class="free">C</span> <span class="skolem">P</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">t</span><span class="main">∈</span><span class="main">{</span><span class="bound">t</span> <span class="main">.</span> prefix <span class="bound">t</span> <span class="main">∧</span> <span class="free">β</span> <span class="bound">t</span> <span class="main">=</span> <span class="skolem">b</span><span class="main">}</span> <span class="main">.</span> <span class="free">PrExecT</span> <span class="skolem">Z</span> <span class="skolem">S</span> <span class="skolem">P</span> <span class="bound">t</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> prefixes_contain_final_bit <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'t</span>"</span></span> 
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">PrExecT</span> <span class="skolem">Z</span> <span class="skolem">A</span> <span class="main">(</span><span class="free">C</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&gt;</span> <span class="free">PrExecT</span> <span class="skolem">Z</span> <span class="skolem">S</span> <span class="skolem">P</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> Prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> difference_in_sum' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">PrExecT</span> <span class="skolem">Z</span> <span class="skolem">A</span> <span class="main">(</span><span class="free">C</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">≠</span> <span class="free">PrExecT</span> <span class="skolem">Z</span> <span class="skolem">S</span> <span class="skolem">P</span> <span class="skolem">t</span>"</span></span>
         <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">PrExecT</span> <span class="skolem">Z</span> <span class="skolem">A</span> <span class="main">(</span><span class="free">C</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> greater_to_unequal_and_nonzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"real"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">&gt;&lt;</span> <span class="main">(</span><span class="free">C</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">p</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span><span class="main">(</span><span class="skolem">S</span> <span class="main">&gt;&lt;</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">p</span><span class="main">)</span><span class="main">)</span> "</span></span>
         <span class="keyword1"><span class="command">using</span></span> Prob Prefix distinguishingZ_differentTrace <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix <span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Prefix prefix_iff_trace_is_prefix <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> A1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> 
<span class="keyword1"><span class="command">qed</span></span>

<span id="UCtoRSCHP"><span class="keyword1"><span class="command">theorem</span></span> UCtoRSCHP<span class="main">:</span>
</span>  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">C</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'uc</span><span class="main">,</span><span class="tfree">'uc</span><span class="main">)</span> comp"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ttype</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'t</span> <span class="main">×</span> real<span class="main">)</span> itself"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">P</span><span class="main">::</span><span class="tfree">'uc</span> prgm<span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="free">C</span> <span class="bound">P</span><span class="main">)</span> <span class="keyword1">UC-emulates</span> <span class="bound">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RSCHP <span class="free">C</span> <span class="free">ttype</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> CF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>RSCHP <span class="free">C</span> <span class="free">ttype</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> CF <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span>  NotRSCHP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">S</span><span class="main">::</span><span class="tfree">'uc</span> ctxt<span class="main">)</span><span class="main">.</span>
      <span class="main">(</span><span class="main">∃</span> <span class="bound">m</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'t</span> <span class="main">×</span> real<span class="main">)</span> <span class="main">.</span> prefix <span class="bound">m</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">&gt;&lt;</span> <span class="main">(</span><span class="free">C</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">↝</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span><span class="bound">S</span> <span class="main">&gt;&lt;</span> <span class="skolem">P</span> <span class="main">↝</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> A1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> Eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">Z</span><span class="main">::</span><span class="tfree">'env</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="free">PrExec</span> <span class="bound">Z</span> <span class="skolem">A</span> <span class="main">(</span><span class="free">C</span> <span class="skolem">P</span><span class="main">)</span> True <span class="main">=</span> <span class="free">PrExec</span> <span class="bound">Z</span> <span class="skolem">S</span> <span class="skolem">P</span> True<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> NotRSCHP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span>  <span class="main">(</span><span class="bound">t</span><span class="main">::</span><span class="tfree">'t</span><span class="main">)</span> <span class="main">(</span><span class="bound">p</span><span class="main">::</span>real<span class="main">)</span> <span class="main">.</span> prefix <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">&gt;&lt;</span> <span class="main">(</span><span class="free">C</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span><span class="skolem">S</span> <span class="main">&gt;&lt;</span> <span class="skolem">P</span> <span class="main">↝</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span>  <span class="skolem"><span class="skolem">t</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> prefix_full<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix <span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">p</span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> Yes<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">&gt;&lt;</span> <span class="main">(</span><span class="free">C</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> No<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">S</span> <span class="main">&gt;&lt;</span> <span class="skolem">P</span> <span class="main">↝</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> prefix_full prefix_iff_trace_is_prefix <span class="keyword1"><span class="command">have</span></span> prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Z</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">Zcan</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> Yes relation_uc prefix <span class="keyword1"><span class="command">have</span></span> PrEx1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">PrExecT</span> <span class="var">?Z</span> <span class="skolem">A</span> <span class="main">(</span><span class="free">C</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">from</span></span> Yes relation_uc prefix <span class="keyword1"><span class="command">have</span></span> p_nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">from</span></span> PrEx1 prefix construct_canonical_env2  prefix 
      <span class="keyword1"><span class="command">have</span></span> LHS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">PrExec</span> <span class="var">?Z</span> <span class="skolem">A</span> <span class="main">(</span><span class="free">C</span> <span class="skolem">P</span><span class="main">)</span> True <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword1"><span class="command">from</span></span> No relation_uc p_nonzero prefix <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="free">PrExecT</span> <span class="var">?Z</span> <span class="skolem">S</span> <span class="skolem">P</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">PrExecT</span> <span class="var">?Z</span> <span class="skolem">S</span> <span class="skolem">P</span> <span class="skolem">t</span> <span class="main">=</span> <span class="free">PrExec</span> <span class="var">?Z</span> <span class="skolem">S</span> <span class="skolem">P</span> True"</span></span>
      <span class="keyword1"><span class="command">using</span></span> construct_canonical_env2 prefix   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> RHS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">PrExec</span> <span class="var">?Z</span> <span class="skolem">S</span> <span class="skolem">P</span> True <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">from</span></span> LHS RHS  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">PrExec</span> <span class="var">?Z</span> <span class="skolem">A</span> <span class="main">(</span><span class="free">C</span> <span class="skolem">P</span><span class="main">)</span> True <span class="main">≠</span> <span class="free">PrExec</span> <span class="var">?Z</span> <span class="skolem">S</span> <span class="skolem">P</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">from</span></span> this Eq <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Relating UC to RHP"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">RHPrel</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">RHPrel</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">::</span> <span class="tfree">'t</span> itself<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">W</span></span></span> <span class="free"><span class="bound"><span class="entity">W'</span></span></span> <span class="main">≡</span> 
        <span class="main">(</span><span class="main">∀</span> <span class="bound">m</span> <span class="main">::</span> <span class="tfree">'t</span> <span class="main">.</span> prefix <span class="bound">m</span> <span class="main">⟶</span>  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">W</span></span></span> <span class="main">↝</span> <span class="bound">m</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">W'</span></span></span> <span class="main">↝</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">RHP</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">RHP</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">::</span> <span class="tfree">'t</span> itself<span class="main">)</span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">P</span> <span class="main">.</span> RRgen <span class="main">(</span>RHPrel <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">::</span> <span class="tfree">'t</span> itself<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="bound">P</span><span class="main">)</span> <span class="bound">P</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> UC 
<span class="keyword2"><span class="keyword">begin</span></span>

<span id="RHPtoUC"><span class="keyword1"><span class="command">theorem</span></span> RHPtoUC<span class="main">:</span>
</span>  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">C</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'uc</span><span class="main">,</span><span class="tfree">'uc</span><span class="main">)</span> comp"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ttype</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'t</span> <span class="main">×</span> real<span class="main">)</span> itself"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"RHP <span class="free">C</span> <span class="free">ttype</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">P</span><span class="main">::</span><span class="tfree">'uc</span> prgm<span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="free">C</span> <span class="bound">P</span><span class="main">)</span> <span class="keyword1">UC-emulates</span> <span class="bound">P</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> RSCHPtoUC assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span id="UCtoRHP"><span class="keyword1"><span class="command">theorem</span></span> UCtoRHP<span class="main">:</span>
</span>  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">C</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'uc</span><span class="main">,</span><span class="tfree">'uc</span><span class="main">)</span> comp"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ttype</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'t</span> <span class="main">×</span> real<span class="main">)</span> itself"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">P</span><span class="main">::</span><span class="tfree">'uc</span> prgm<span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="free">C</span> <span class="bound">P</span><span class="main">)</span> <span class="keyword1">UC-emulates</span> <span class="bound">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RHP <span class="free">C</span> <span class="free">ttype</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> CF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>RHP <span class="free">C</span> <span class="free">ttype</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> CF <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span>  NotRSCHP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">S</span><span class="main">::</span><span class="tfree">'uc</span> ctxt<span class="main">)</span><span class="main">.</span>
      <span class="main">(</span><span class="main">∃</span> <span class="bound">m</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'t</span> <span class="main">×</span> real<span class="main">)</span> <span class="main">.</span> prefix <span class="bound">m</span> <span class="main">∧</span>  <span class="main">(</span><span class="skolem">A</span> <span class="main">&gt;&lt;</span> <span class="main">(</span><span class="free">C</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">↝</span> <span class="bound">m</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="bound">S</span> <span class="main">&gt;&lt;</span> <span class="skolem">P</span> <span class="main">↝</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> A1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> Eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">Z</span><span class="main">::</span><span class="tfree">'env</span><span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="free">PrExec</span> <span class="bound">Z</span> <span class="skolem">A</span> <span class="main">(</span><span class="free">C</span> <span class="skolem">P</span><span class="main">)</span> True <span class="main">=</span> <span class="free">PrExec</span> <span class="bound">Z</span> <span class="skolem">S</span> <span class="skolem">P</span> True<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> NotRSCHP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span>  <span class="main">(</span><span class="bound">t</span><span class="main">::</span><span class="tfree">'t</span><span class="main">)</span> <span class="main">(</span><span class="bound">p</span><span class="main">::</span>real<span class="main">)</span> <span class="main">.</span> prefix <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="skolem">A</span> <span class="main">&gt;&lt;</span> <span class="main">(</span><span class="free">C</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">↝</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="skolem">S</span> <span class="main">&gt;&lt;</span> <span class="skolem">P</span> <span class="main">↝</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span>  <span class="skolem"><span class="skolem">t</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">AY</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">AN</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">PY</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">PN</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> prefix_full<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix <span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">p</span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> Yes<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">AY</span> <span class="main">&gt;&lt;</span> <span class="skolem">PY</span> <span class="main">↝</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> No<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">AN</span> <span class="main">&gt;&lt;</span> <span class="skolem">PN</span> <span class="main">↝</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> Dunno<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">AY</span>  <span class="main">=</span> <span class="skolem">A</span> <span class="main">∧</span> <span class="skolem">PY</span> <span class="main">=</span> <span class="free">C</span> <span class="skolem">P</span> <span class="main">∧</span> <span class="skolem">AN</span> <span class="main">=</span> <span class="skolem">S</span> <span class="main">∧</span> <span class="skolem">PN</span> <span class="main">=</span> <span class="skolem">P</span><span class="main">)</span>
                 <span class="main">∨</span><span class="main">(</span><span class="skolem">AN</span>  <span class="main">=</span> <span class="skolem">A</span> <span class="main">∧</span> <span class="skolem">PN</span> <span class="main">=</span> <span class="free">C</span> <span class="skolem">P</span> <span class="main">∧</span> <span class="skolem">AY</span> <span class="main">=</span> <span class="skolem">S</span> <span class="main">∧</span> <span class="skolem">PY</span> <span class="main">=</span> <span class="skolem">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">from</span></span> prefix_full prefix_iff_trace_is_prefix <span class="keyword1"><span class="command">have</span></span> prefix<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Z</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">Zcan</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> Yes relation_uc prefix <span class="keyword1"><span class="command">have</span></span> PrEx1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">PrExecT</span> <span class="var">?Z</span> <span class="skolem">AY</span> <span class="skolem">PY</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">from</span></span> Yes relation_uc prefix <span class="keyword1"><span class="command">have</span></span> p_nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">from</span></span> PrEx1 prefix construct_canonical_env2  prefix 
      <span class="keyword1"><span class="command">have</span></span> LHS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">PrExec</span> <span class="var">?Z</span> <span class="skolem">AY</span> <span class="skolem">PY</span> True <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword1"><span class="command">from</span></span> No relation_uc p_nonzero prefix <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="free">PrExecT</span> <span class="var">?Z</span> <span class="skolem">AN</span> <span class="skolem">PN</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">PrExecT</span> <span class="var">?Z</span> <span class="skolem">AN</span> <span class="skolem">PN</span> <span class="skolem">t</span> <span class="main">=</span> <span class="free">PrExec</span> <span class="var">?Z</span> <span class="skolem">AN</span> <span class="skolem">PN</span> True"</span></span>
      <span class="keyword1"><span class="command">using</span></span> construct_canonical_env2 prefix   <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> RHS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">PrExec</span> <span class="var">?Z</span> <span class="skolem">AN</span> <span class="skolem">PN</span> True <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">from</span></span> LHS RHS  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">PrExec</span> <span class="var">?Z</span> <span class="skolem">AY</span> <span class="skolem">PY</span> True <span class="main">≠</span> <span class="free">PrExec</span> <span class="var">?Z</span> <span class="skolem">AN</span> <span class="skolem">PN</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">from</span></span> this Eq Dunno <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Translating UC results to programming languages"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> RRGen_is_transitive <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P1</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">)</span> prgm"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P2</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span><span class="main">)</span> prgm"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P3</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'r</span><span class="main">)</span> prgm"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="main">.</span> <span class="free">rel12</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">∧</span> <span class="free">rel23</span> <span class="bound">b</span> <span class="bound">c</span> <span class="main">⟶</span> <span class="free">rel13</span> <span class="bound">a</span> <span class="bound">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"RRgen <span class="free">rel12</span> <span class="free">P1</span> <span class="free">P2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"RRgen <span class="free">rel23</span> <span class="free">P2</span> <span class="free">P3</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"RRgen <span class="free">rel13</span> <span class="free">P1</span> <span class="free">P3</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span>
  <span class="keyword1"><span class="command">from</span></span> A <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S2</span></span> <span class="keyword2"><span class="keyword">where</span></span> R1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rel12</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">&gt;&lt;</span> <span class="free">P1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">S2</span> <span class="main">&gt;&lt;</span> <span class="free">P2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> B <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S3</span></span> <span class="keyword2"><span class="keyword">where</span></span> R2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rel23</span> <span class="main">(</span><span class="skolem">S2</span> <span class="main">&gt;&lt;</span> <span class="free">P2</span><span class="main">)</span> <span class="main">(</span><span class="skolem">S3</span> <span class="main">&gt;&lt;</span> <span class="free">P3</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> R1 R2 trans <span class="keyword1"><span class="command">have</span></span> R3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rel13</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">&gt;&lt;</span> <span class="free">P1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">S3</span> <span class="main">&gt;&lt;</span> <span class="free">P3</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">S</span><span class="main">.</span> <span class="free">rel13</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">&gt;&lt;</span> <span class="free">P1</span><span class="main">)</span> <span class="main">(</span><span class="bound">S</span> <span class="main">&gt;&lt;</span> <span class="free">P3</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* First, we need transitivity for RSCHPrel. *)</span>
<span class="comment1">(* TODO, later see if we can generalise to traces that projects of UC *)</span>
<span class="keyword1"><span class="command">lemma</span></span> RSCHPrel <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ttype</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'t</span> <span class="main">×</span> real<span class="main">)</span> itself"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span><span class="quoted"><span class="quoted">"RSCHPrel <span class="free">ttype</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A2<span class="main">:</span><span class="quoted"><span class="quoted">"RSCHPrel <span class="free">ttype</span> <span class="free">b</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RSCHPrel <span class="free">ttype</span> <span class="free">a</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> A1 A2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>   

<span class="comment1">(* longer version of theorem below *)</span>
<span class="comment1">(*
theorem lifted_RSCHP:
  fixes UCC ::"('uc,'uc) comp" (* This can be seen as one for more UC results. *)
  fixes C1 ::"('b,'uc) comp"  
  fixes C2 ::"('uc,'r) comp"  
  fixes ttype :: "('t × real) itself"  
  assumes AUCC: "RSCHP UCC ttype"
  assumes AC1:  "RSCHP C1 ttype"
  assumes AC2:  "RSCHP C2 ttype"
  shows "RSCHP (C2 ∘ UCC ∘ C1) ttype"
proof
  fix P
  let ?P2 = "(C1 P)"
  let ?P3 = "(UCC ?P2)"
  let ?P4 = "(C2 ?P3)"
  let ?C = "C2 ∘ UCC ∘ C1"

  from AC2 have "RRgen (RSCHPrel ttype) ?P4 ?P3" by blast
  moreover from AUCC have "RRgen (RSCHPrel ttype) ?P3 ?P2" by blast
  moreover from AC1 have "RRgen (RSCHPrel ttype) ?P2 (P)" by blast
  ultimately show  "RRgen (RSCHPrel ttype) (?C P) (P)"
     by (metis comp_apply)
qed
*)</span>

<span id="UC"><span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> UC<span class="main">)</span> implementUC<span class="main">:</span> 
</span>  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">UCC</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'uc</span><span class="main">,</span><span class="tfree">'uc</span><span class="main">)</span> comp"</span></span> <span class="comment1">(* This can be seen as one for more UC results. *)</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">C1</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">,</span><span class="tfree">'uc</span><span class="main">)</span> comp"</span></span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">C2</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'uc</span><span class="main">,</span><span class="tfree">'r</span> <span class="main">)</span> comp"</span></span>  
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ttype</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'t</span> <span class="main">×</span> real<span class="main">)</span> itself"</span></span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> AUCC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">P</span><span class="main">::</span><span class="tfree">'uc</span> prgm<span class="main">)</span> <span class="main">.</span> <span class="main">(</span><span class="free">UCC</span> <span class="bound">P</span><span class="main">)</span> <span class="keyword1">UC-emulates</span> <span class="bound">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> AC1<span class="main">:</span>  <span class="quoted"><span class="quoted">"RSCHP <span class="free">C1</span> <span class="free">ttype</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> AC2<span class="main">:</span>  <span class="quoted"><span class="quoted">"RSCHP <span class="free">C2</span> <span class="free">ttype</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RSCHP <span class="main">(</span><span class="free">C2</span> <span class="main">∘</span> <span class="free">UCC</span> <span class="main">∘</span> <span class="free">C1</span><span class="main">)</span> <span class="free">ttype</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> UCtoRSCHP AUCC AC1 AC2
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_apply<span class="main">)</span> 


<span class="comment1">(* TODO Theorem 4 atm invalid, no error symbol.
theorem (in UC) UC_compiler:
  fixes UCC::"('uc,'uc) comp" (* This can be seen as one for more UC results. *)
  fixes C1 ::"('b ,'uc) comp"  
  fixes C2 ::"('uc,'r ) comp"  
  fixes ttype :: "('t × real) itself"  
  assumes AC1:  "RSCHP C1 ttype"
  assumes AC2:  "RSCHP C2 ttype"
  fixes F:"'uc prgm"
  fixes PF:"'b prgm"
  fixes pi:"'uc prgm"
  fixes Ppi:"'r prgm"
  assumes "C1 PF = F"
  assumes "C2 pi = Rpi"
*)</span>    

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</body>

</html>